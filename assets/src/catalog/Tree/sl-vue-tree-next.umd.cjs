(function(x,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],o):(x=typeof globalThis<"u"?globalThis:x||self,o(x.SLVueTreeNext={},x.Vue))})(this,function(x,o){"use strict";const G=(g,b)=>{if(R(g)&&R(b))for(const y in b)R(b[y])?(g[y]||Object.assign(g,{[y]:{}}),G(g[y],b[y])):Object.assign(g,{[y]:b[y]});return g},R=g=>g&&typeof g=="object"&&!Array.isArray(g),ye={ref:"nodes",class:"sl-vue-tree-next-nodes-list"},Ce=["onPointerdown","onPointerup","onContextmenu","onDblclick","onClick","onDragover","onDrop","path"],xe={class:"sl-vue-tree-next-gap"},be={key:0,class:"sl-vue-tree-next-branch"},ve={key:0},ke={key:1},Be={class:"sl-vue-tree-next-title"},De=["onClick"],we={class:"sl-vue-tree-next-sidebar"},Ee=o.defineComponent({__name:"SlVueTreeNext",props:{modelValue:{default:()=>[]},edgeSize:{default:3},allowMultiselect:{type:Boolean,default:!0},showBranches:{type:Boolean,default:!1},level:{default:0},parentInd:{default:void 0},parentContext:{},rootContext:{},allowToggleBranch:{type:Boolean,default:!0},multiSelectKey:{},scrollAreaHeight:{default:70},maxScrollSpeed:{default:20}},emits:["update:modelValue","select","beforedrop","drop","toggle","nodeclick","nodedblclick","updateNode","nodecontextmenu","externaldragover","externaldrop"],setup(g,{expose:b,emit:y}){const u=g,Q=y,w=o.ref(),Z=o.ref(),z=o.ref(null),I=o.ref(0),A=o.ref(0),L=o.ref(null),T=o.ref(!1),v=o.ref(!1),Y=o.ref({x:0,y:0}),H=o.ref(!1),m=o.ref([]),p=o.computed(()=>!u.level),ee=o.computed(()=>{const e=[];let t=u.level-1;for(u.showBranches||t++;t-- >0;)e.push(t);return e}),f=o.computed(()=>{var t;return p.value?z.value:(t=q())==null?void 0:t.cursorPosition.value}),te=o.computed(()=>ee.value.length),J=o.computed(()=>{var t,r,l,s;if(p.value){const n=C(m.value);return le(n)}return u.parentInd===null?[]:(s=(l=(r=(t=q())==null?void 0:t.currentNodes)==null?void 0:r.value)==null?void 0:l[u.parentInd])==null?void 0:s.children}),oe=o.computed(()=>fe().length);o.computed(()=>M().length),o.onMounted(()=>{p.value&&document.addEventListener("mouseup",ue)}),o.onBeforeUnmount(()=>{document.removeEventListener("mouseup",ue)}),o.watchEffect(()=>{m.value=u.modelValue});const B=e=>{var t;if(p.value){z.value=e;return}(t=q())==null||t.setCursorPosition(e)},le=(e,t=[],r=!0)=>e.map((l,s)=>{const n=t.concat(s);return D(n,l,e,r)}),D=(e,t=null,r=null,l=null)=>{const s=e.slice(-1)[0];if(r=r||O(m.value,e),t=t||r&&r[s]||null,l==null&&(l=F==null?void 0:F(e)),!t)return null;const n=t.isExpanded==null?!0:!!t.isExpanded,a=t.isDraggable==null?!0:!!t.isDraggable,i=t.isSelectable==null?!0:!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?le(t.children,e,n):[],isSelected:!!t.isSelected,isExpanded:n,isVisible:l,isDraggable:a,isSelectable:i,data:t.data!==void 0?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:s,isFirstChild:s==0,isLastChild:s==((r==null?void 0:r.length)??0)-1}},F=e=>{if(e.length<2)return!0;let t=m.value;for(let r=0;r<e.length-1;r++){let l=e[r],s=t[l];if(!(s.isExpanded==null?!0:!!s.isExpanded))return!1;t=s.children||[]}return!0},E=e=>{m.value=e,d().emit("update:modelValue",e)},Pe=(e,t)=>{d().emit("select",e,t)},Ve=(e,t,r)=>{d().emit("beforedrop",e,t,r)},Ie=(e,t,r)=>{d().emit("drop",e,t,r)},Le=(e,t)=>{d().emit("toggle",e,t)},Te=(e,t)=>{d().emit("nodeclick",e,t)},He=(e,t)=>{d().emit("nodedblclick",e,t)},Oe=(e,t)=>{d().emit("nodecontextmenu",e,t)},$e=(e,t)=>{t.preventDefault();const r=d(),l=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.setCursorPosition(l),r.emit("externaldragover",l,t)},Re=(e,t)=>{const r=d(),l=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.emit("externaldrop",l,t),B(null)},K=(e,t=!1,r=null)=>{const l=Array.isArray(u.multiselectKey)?u.multiselectKey:[u.multiselectKey];t=(r&&!!l.find(S=>r[S])||t)&&u.allowMultiselect;const n=D(e);if(!n)return null;const a=C(m.value),i=u.allowMultiselect&&r&&r.shiftKey&&L.value,c=[];let h=!1;return N((S,k)=>{var V;i?((S.pathStr===n.pathStr||S.pathStr===((V=L.value)==null?void 0:V.pathStr))&&(k.isSelected=S.isSelectable,h=!h),h&&(k.isSelected=S.isSelectable)):S.pathStr===n.pathStr?k.isSelected=S.isSelectable:t||k.isSelected&&(k.isSelected=!1),k.isSelected&&c.push(S)},a),L.value=n,E(a),Pe(c,r),n},re=e=>{var Se,Ne;if(!p.value){(Se=d())==null||Se.onMousemoveHandler(e);return}if(H.value)return;const t=v.value,r=t||T.value&&(Y.value.x!==e.clientX||Y.value.y!==e.clientY),l=t===!1&&r===!0;if(Y.value={x:e.clientX,y:e.clientY},!r)return;const s=d().ref.value,n=s.getBoundingClientRect(),a=e.clientY-n.top+s.scrollTop-Number(((Ne=w.value)==null?void 0:Ne.style.marginBottom)??0),i=e.clientX-n.left;w.value&&(w.value.style.top=a+"px",w.value.style.left=i+"px");const c=ne(e.clientX,e.clientY),h=c==null?void 0:c.node,S=c==null?void 0:c.placement;if(l&&!h.isSelected&&K(h.path,!1,e),!M().length){H.value=!0;return}v.value=r,B({node:h,placement:S});const V=n.bottom-u.scrollAreaHeight,ge=(e.clientY-V)/(n.bottom-V),me=n.top+u.scrollAreaHeight,he=(me-e.clientY)/(me-n.top);ge>0?de(ge):he>0?de(-he):j()},ne=(e,t)=>{const r=document.elementFromPoint(e,t),l=r!=null&&r.getAttribute("path")?r:se(r);let s,n;if(l){if(!l)return;s=D(JSON.parse(l.getAttribute("path")));const a=l.offsetHeight,i=u.edgeSize,c=t-l.getBoundingClientRect().top;s.isLeaf?n=c>=a/2?"after":"before":c<=i?n="before":c>=a-i?n="after":n="inside"}else{const i=d().ref.value.getBoundingClientRect();t>i.top+i.height/2?(n="after",s=ie()):(n="before",s=_())}return{node:s,placement:n}},se=e=>e?e.getAttribute("path")?e:se(e.parentElement):null,ze=e=>{if(!p.value||!v.value)return;const r=d().ref.value.getBoundingClientRect();if(e.clientY>=r.bottom){const l=structuredClone(J.value);B({node:l[0],placement:"after"})}else e.clientY<r.top&&B({node:_(),placement:"before"})},Ae=e=>d().ref.value.querySelector(`[path="${JSON.stringify(e)}"]`),ie=()=>{let e=null;return N(t=>{e=t}),e},_=()=>D([0]),Ye=(e,t)=>{let r=null;return N(l=>{if(!(ae(l.path,e)<1)&&(!t||t(l)))return r=l,!1}),r},Je=(e,t)=>{let r=[];N(s=>{if(ae(s.path,e)>=0)return!1;r.push(s)});let l=r.length;for(;l--;){const s=r[l];if(!t||t(s))return s}return null},ae=(e,t)=>{for(let r=0;r<e.length;r++){if(t[r]==null||e[r]>t[r])return 1;if(e[r]<t[r])return-1}return t[e.length]==null?0:-1},ce=(e,t)=>{if(e.button===0){if(!p.value){d().onNodeMousedownHandler(e,t);return}T.value=!0}},de=e=>{const t=d().ref.value;A.value!==e&&(I.value&&j(),A.value=e,I.value=setInterval(()=>{t.scrollTop+=u.maxScrollSpeed*e},20))},j=()=>{clearInterval(I.value),I.value=0,A.value=0},ue=e=>{v.value&&X(e)},X=(e,t=null)=>{if(e.button!==0)return;if(!p.value){d().onNodeMouseupHandler(e,t);return}if(T.value=!1,!v.value&&t&&!H.value&&K(t.path,!1,e),H.value=!1,!f.value){P();return}const r=M();for(let i of r){if(i.pathStr==f.value.node.pathStr){P();return}if(Xe(i,f.value.node)){P();return}}const l=C(m.value),s=[];for(let i of r){const h=O(l,i.path)[i.ind];s.push(h)}let n=!1;if(Ve(r,f.value,()=>n=!0),n){P();return}const a=[];for(let i of s)a.push(C(i)),i.toBeDeleted=!0;pe(f.value,a,l),W((i,c,h)=>{i.toBeDeleted&&c.splice(h,1)},l),L.value=null,E(l),Ie(r,f.value,e),P()},Fe=(e,t)=>{u.allowToggleBranch&&(U({path:t.path,patch:{isExpanded:!t.isExpanded}}),Le(t,e),e.stopPropagation())},P=()=>{v.value=!1,T.value=!1,B(null),j()},q=()=>u.parentContext,d=()=>p.value?$:u.rootContext,O=(e,t)=>t.length===1?e:O(e[t[0]].children,t.slice(1)),U=({path:e,patch:t})=>{if(!p.value){Q("updateNode",{path:e,patch:t});return}const r=JSON.stringify(e),l=C(m.value);N((s,n)=>{if(s.pathStr===r)return G(n,t),!1},l),E(l)},fe=()=>{const e=[];return N(t=>{t.isSelected&&e.push(t)}),e},Ke=(e,t)=>JSON.stringify(e.path.slice(0,t.path.length))===t.pathStr,M=()=>{const e=[];return N(t=>{t.isSelected&&t.isDraggable&&(e.some(l=>Ke(t,l))||e.push(t))}),e},N=(e,t=null,r=[])=>{t||(t=m.value);let l=!1;const s=[];for(let n=0;n<t.length;n++){const a=t[n],i=r.concat(n),c=D(i,a,t);if(l=e(c,a,t)===!1,c&&s.push(c),l||a.children&&(l=N(e,a.children,i)===!1,l))break}return l?!1:s},W=(e,t)=>{let r=t.length;for(;r--;){const l=t[r];l.children&&W(e,l.children),e(l,t,r)}return t},_e=e=>{const t=e.map(l=>JSON.stringify(l)),r=C(m.value);N((l,s,n)=>{for(const a of t)l.pathStr===a&&(s.toBeDeleted=!0)},r),W((l,s,n)=>{l.toBeDeleted&&s.splice(n,1)},r),E(r)},pe=(e,t,r)=>{const l=C(e),s=l.node,n=O(r,s.path),a=n[s.ind];if(l.placement==="inside")a.children=a.children||[],a.children.unshift(...t);else{const i=l.placement==="before"?s.ind:s.ind+1;n.splice(i,0,...t)}},je=(e,t)=>{const r=Array.isArray(t)?t:[t],l=C(m.value);pe(e,r,l),E(l)},Xe=(e,t)=>{const l=C(t).path;return JSON.stringify(l.slice(0,e.path.length))==e.pathStr},C=e=>JSON.parse(JSON.stringify(e)),$={getRoot:d,setCursorPosition:B,currentNodes:J,cursorPosition:f,emit:Q,ref:Z,onNodeMousedownHandler:ce,onNodeMouseupHandler:X,onMousemoveHandler:re,getCursorPositionFromCoords:ne,updateNode:U,getNode:D,traverse:N,select:K,getNodeEl:Ae,getFirstNode:_,getLastNode:ie,getNextNode:Ye,getPrevNode:Je,getSelected:fe,insert:je,remove:_e,rootCursorPosition:z,selectionSize:oe};return b($),(e,t)=>{const r=o.resolveComponent("SlVueTreeNext",!0);return o.openBlock(),o.createElementBlock("div",{ref_key:"rootRef",ref:Z,class:o.normalizeClass(["sl-vue-tree-next",{"sl-vue-tree-next-root":p.value}]),onPointermove:re,onPointerleave:ze,style:{"touch-action":"none"}},[o.createElementVNode("div",ye,[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(J.value,(l,s)=>(o.openBlock(),o.createElementBlock("div",{class:o.normalizeClass(["sl-vue-tree-next-node",{"sl-vue-tree-next-selected":l.isSelected}])},[o.createElementVNode("div",{class:"sl-vue-tree-next-cursor sl-vue-tree-next-cursor_before",onDragover:t[0]||(t[0]=o.withModifiers(()=>{},["prevent"])),style:o.normalizeStyle({visibility:f.value&&f.value.node.pathStr===l.pathStr&&f.value.placement==="before"?"visible":"hidden","--depth":te.value})},null,36),o.createElementVNode("div",{class:o.normalizeClass(["sl-vue-tree-next-node-item",{"sl-vue-tree-next-cursor-hover":f.value&&f.value.node.pathStr===l.pathStr,"sl-vue-tree-next-cursor-inside":f.value&&f.value.placement==="inside"&&f.value.node.pathStr===l.pathStr,"sl-vue-tree-next-node-is-leaf":l.isLeaf,"sl-vue-tree-next-node-is-folder":!l.isLeaf}]),onPointerdown:n=>ce(n,l),onPointerup:n=>X(n,l),onContextmenu:n=>Oe(l,n),onDblclick:n=>He(l,n),onClick:n=>Te(l,n),onDragover:n=>$e(l,n),onDrop:n=>Re(l,n),path:l.pathStr},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(ee.value,n=>(o.openBlock(),o.createElementBlock("div",xe))),256)),e.level&&e.showBranches?(o.openBlock(),o.createElementBlock("div",be,[o.renderSlot(e.$slots,"branch",{node:l},()=>[l.isLastChild?o.createCommentVNode("",!0):(o.openBlock(),o.createElementBlock("span",ve,o.toDisplayString("├")+o.toDisplayString("─")+"  ",1)),l.isLastChild?(o.openBlock(),o.createElementBlock("span",ke,o.toDisplayString("└")+o.toDisplayString("─")+"  ",1)):o.createCommentVNode("",!0)])])):o.createCommentVNode("",!0),o.createElementVNode("div",Be,[l.isLeaf?o.createCommentVNode("",!0):(o.openBlock(),o.createElementBlock("span",{key:0,class:"sl-vue-tree-next-toggle",onClick:n=>Fe(n,l)},[o.renderSlot(e.$slots,"toggle",{node:l},()=>[o.createElementVNode("span",null,o.toDisplayString(l.isLeaf?"":l.isExpanded?"-":"+"),1)])],8,De)),o.renderSlot(e.$slots,"title",{node:l},()=>[o.createTextVNode(o.toDisplayString(l.title),1)]),!l.isLeaf&&l.children.length==0&&l.isExpanded?o.renderSlot(e.$slots,"empty-node",{key:1,node:l}):o.createCommentVNode("",!0)]),o.createElementVNode("div",we,[o.renderSlot(e.$slots,"sidebar",{node:l})])],42,Ce),l.children&&l.children.length&&l.isExpanded?(o.openBlock(),o.createBlock(r,{key:0,"model-value":l.children,level:l.level,"parent-ind":s,"allow-multiselect":e.allowMultiselect,"allow-toggle-branch":e.allowToggleBranch,"edge-size":e.edgeSize,"show-branches":e.showBranches,"parent-context":$,"root-context":p.value?$:e.rootContext,onUpdateNode:U,onDragover:t[1]||(t[1]=o.withModifiers(()=>{},["prevent"]))},{title:o.withCtx(({node:n})=>[o.renderSlot(e.$slots,"title",{node:n},()=>[o.createTextVNode(o.toDisplayString(n.title),1)])]),toggle:o.withCtx(({node:n})=>[o.renderSlot(e.$slots,"toggle",{node:n},()=>[o.createElementVNode("span",null,o.toDisplayString(n.isLeaf?"":n.isExpanded?"-":"+"),1)])]),sidebar:o.withCtx(({node:n})=>[o.renderSlot(e.$slots,"sidebar",{node:n})]),"empty-node":o.withCtx(({node:n})=>[!n.isLeaf&&n.children.length==0&&n.isExpanded?o.renderSlot(e.$slots,"empty-node",{key:0,node:n}):o.createCommentVNode("",!0)]),_:2},1032,["model-value","level","parent-ind","allow-multiselect","allow-toggle-branch","edge-size","show-branches","root-context"])):o.createCommentVNode("",!0),o.createElementVNode("div",{class:"sl-vue-tree-next-cursor sl-vue-tree-next-cursor_after",onDragover:t[2]||(t[2]=o.withModifiers(()=>{},["prevent"])),style:o.normalizeStyle({visibility:f.value&&f.value.node.pathStr===l.pathStr&&f.value.placement==="after"?"visible":"hidden","--depth":te.value})},null,36)],2))),256)),p.value?o.withDirectives((o.openBlock(),o.createElementBlock("div",{key:0,ref_key:"dragInfoRef",ref:w,class:"sl-vue-tree-next-drag-info"},[o.renderSlot(e.$slots,"draginfo",{},()=>[o.createTextVNode(" Items: "+o.toDisplayString(oe.value),1)])],512)),[[o.vShow,v.value]]):o.createCommentVNode("",!0)],512)],34)}}});x.SlVueTreeNext=Ee,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
